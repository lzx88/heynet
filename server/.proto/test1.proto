

 {
    T = {
      1 = {
        name = "type.field"
        field = {
          1 = {
            name = "name"
            type = -1
          }
          3 = {
            name = "type"
            key = "[]"
            type = -1
          }
        }
      }
      2 = {
        name = "p0.response"
        field = {
          1 = {
            name = "index"
            type = 3
          }
        }
      }
      3 = {
        name = "type"
        field = {
          2 = {
            name = "fields"
            key = 1
            type = 1
          }
        }
      }
      4 = {
        name = "protocol.response"
        field = {
          1 = {
            name = "index"
            type = -1
          }
        }
      }
      5 = {
        name = "type1.field"
        field = {
          1 = {
            name = "name"
            type = -2
          }
          2 = {
            name = "buildin"
            type = -1
          }
          3 = {
            name = "type"
            key = "[]"
            type = -1
          }
          4 = {
            name = "tag"
            type = -1
          }
          5 = {
            name = "integer"
            type = -3
          }
        }
      }
    }
    P = {
      1 = {
        name = "test.p1"
        response = 1
        field = {}
      }
      2122 = {
        name = "test1.roup"
        response = 5
        field = {}
      }
      202 = {
        name = "test1.protocol"
        response = 4
        field = {
          1 = {
            name = "name"
            type = -2
          }
          2 = {
            name = "buildin"
            type = -1
          }
        }
      }
      20 = {
        name = "test.p0"
        response = 2
        field = {
          1 = {
            name = "name"
            type = -2
          }
          2 = {
            name = "nnn"
            type = 1
          }
        }
      }
    }
}

    /********************************************************************
      created:  2014/12/16
      filename: luahelper.h
      version:  1.0
      purpose:  一些辅助宏 by z
    *********************************************************************/
    #ifndef luahelper_h__
    #define luahelper_h__
     
    #include "LUAEngine.h"
     
    class ZLuaHelper
    {
    private:
      lua_State* L;
      int i;
    public:
      bool check(){return i-- > 0;}
      ZLuaHelper(lua_State* ls)
        :L(ls),i(1){}
      ~ZLuaHelper() {lua_pop(L, 1);}
    };
     
    template<typename T>
    inline void luaGetData(lua_State* L, int idx, T& val) { val = (T)lua_tointeger(L, idx);}
    template<>
    inline void luaGetData<string>(lua_State* L, int idx, string& val){ val = lua_tostring(L, idx);}
    template<>
    inline void luaGetData<const char*>(lua_State* L, int idx, const char*& val){ val = lua_tostring(L, idx);}
    inline void luaGetField(lua_State* L, int idx, int k) { lua_rawgeti(L, idx, k);}
    inline void luaGetField(lua_State* L, int idx, const char* k) { lua_getfield(L, idx, k);}
     
    #define IF_GetLuaTaByIdx(L, k, idx) luaGetField(L, idx, k); for(ZLuaHelper hel(L); hel.check() && !lua_isnil(L, -1) && lua_istable(L, -1);)
    #define IF_GetLuaTab(L, k) IF_GetLuaTaByIdx(L, k, -1)
    #define For_LuaTab(L)  for(lua_pushnil(L); 0 != lua_next(L, -2); lua_pop(L, 1))
    #define GetLuaTabMember(L, k, val) luaGetField(L, -1, k); luaGetData(L, -1, val); lua_pop(L, 1)
     
    #endif//luahelper_h__